var MARGIN=156,MAP_DIMENSION_SIZE=512,EDGE=0,SPECIES=1,COMPARTMENT=3,REACTION=2,BG_SPECIES=4,BG_REACTION=5,BG_COMPARTMENT=6,BG=[BG_SPECIES,BG_REACTION,BG_COMPARTMENT],TRANSPORT="transport to outside",MIN_LABEL_SIZE=10,MAX_LABEL_SIZE=16,TRANSPORT_MASK=1,NON_TRANSPORT_MASK=1<<1,UBIQUITOUS_MASK=1<<2;function pnt2layer(O,P,E,i,G,a,H,t,u,N,g,q,v,c){var K=i.geometry.coordinates,d=Math.pow(2,G),s=i.properties.w;if(EDGE==i.properties.type){var f={color:i.properties.color,opacity:1,weight:Math.max(Math.min(s/2,10),2),lineCap:"round",lineJoin:"round",clickable:false,fill:false,zIndexOffset:0,riseOnHover:false};if(0!=(i.properties.layer&TRANSPORT_MASK)){f.opacity=0.5;f.dashArray="2, 3";f.weight=Math.max(Math.min(s/4,8),1.5)}return L.polyline(K.map(function(e){return O.unproject(e,1)}),f)}if(SPECIES==i.properties.type||BG_SPECIES==i.properties.type){s/=Math.sqrt(2)}var p=K[0],o=K[1],D=-1!==BG.indexOf(i.properties.type),f={name:i.properties.name,title:i.properties.name,alt:i.properties.name,id:i.properties.id,color:BG_COMPARTMENT!=i.properties.type?"white":i.properties.color,fillColor:i.properties.color,fillOpacity:BG_COMPARTMENT==i.properties.type?0:(D?0.3:1),opacity:1,weight:BG_COMPARTMENT!=i.properties.type?(D?0:Math.min(1,s/10*d)):4,fill:true,clickable:!D,zIndexOffset:D?6:0,riseOnHover:!D},I=(BG_COMPARTMENT==i.properties.type||COMPARTMENT==i.properties.type)?i.properties.h:s,l=new L.LatLngBounds(O.unproject([p-s,o+I],1),O.unproject([p+s,o-I],1)),C=O.unproject([p,o],1),j=l.getNorthEast(),B=l.getSouthWest(),z=s*40075000*Math.cos(C.lat*(Math.PI/180))/Math.pow(2,t+8);if(BG_COMPARTMENT==i.properties.type||COMPARTMENT==i.properties.type){if(H[2]==null||(BG_COMPARTMENT==i.properties.type&&u==i.properties.c_id||COMPARTMENT==i.properties.type&&u==i.properties.id)){H[2]=C}}if(BG_REACTION==i.properties.type){return L.rectangle(l,f)}if(BG_SPECIES==i.properties.type){return L.circle(C,z,f)}var F=null;if(REACTION==i.properties.type||COMPARTMENT==i.properties.type||BG_COMPARTMENT==i.properties.type){F=L.rectangle(l,f)}else{if(SPECIES==i.properties.type){F=L.circle(C,z,f)}else{return null}}H[0][0]=H[0][0]==null?B.lat:Math.min(H[0][0],B.lat);H[0][1]=H[0][1]==null?B.lng:Math.max(H[0][1],B.lng);H[1][0]=H[1][0]==null?j.lat:Math.max(H[1][0],j.lat);H[1][1]=H[1][1]==null?j.lng:Math.min(H[1][1],j.lng);var b=undefined,n=undefined;function M(h){if(!c.hasOwnProperty(h)){c[h]=L.featureGroup()}var e=c[h];e.addLayer(highlightCircle(C,z));O.on("popupopen",function(r){if(r.popup===b){if(O.hasLayer(E)){P.addLayer(e)}}});O.on("popupclose",function(r){if(r.popup===b){P.removeLayer(e)}})}if(BG_COMPARTMENT!=i.properties.type){b=getPopup(i,N,g);b.setLatLng(C);F.bindPopup(b);if(SPECIES==i.properties.type){M(i.properties.id)}[i.properties.name,i.properties.id,i.properties.t,i.properties.lbl].forEach(function(e){if(e){e=e.replace(new RegExp("(<sub>)|(</sub>)","g"),"");if(!q.hasOwnProperty(e)){q[e]=b}if(!v.hasOwnProperty(e)){v[e]=[G,a]}}});n=getLabel(i);F.bindLabel(n,{direction:"auto",opacity:1})}F=L.featureGroup([F]);var J=(REACTION==i.properties.type?i.properties.id:(SPECIES==i.properties.type?i.properties.lbl:i.properties.name)),k=Math.max(G,Math.ceil(Math.log(Math.max(MIN_LABEL_SIZE/I,J.length/(2*s)))/Math.LN2));if(k<=a){var A=MIN_LABEL_SIZE;var m=L.marker(C,{icon:L.divIcon({className:"element-label",html:'<span class="label-span" style="font-size:'+A+"px;line-height:"+(A+2)+"px;color:"+(BG_COMPARTMENT==i.properties.type?i.properties.color:"black")+'">'+J+"</span>",iconSize:[s*Math.pow(2,k+1),(A+3)],zIndexOffset:0,riseOnHover:false,riseOffset:0})});if(b!=undefined){m.bindPopup(b)}if(n!=undefined){m.bindLabel(n,{direction:"auto",opacity:1})}if(typeof O.getZoom()!=="undefined"){if(O.getZoom()>=k&&O.getZoom()<=a){F.addLayer(m)}}else{if(G==k){F.addLayer(m)}}O.on("zoomend",function(h){if(O.getZoom()>=k&&O.getZoom()<=a){if(!F.hasLayer(m)){F.addLayer(m)}}else{F.removeLayer(m)}})}if(b!=undefined){F.bindPopup(b)}if(n!=undefined){F.bindLabel(n,{direction:"auto",opacity:1})}if(COMPARTMENT==i.properties.type){O.on("zoomend",function(r){var h=O.getBounds();if(O.getZoom()>t+2&&O.getBounds().intersects(l)&&(O.getZoom()==O.getMaxZoom()||l.contains(h.getSouthWest())&&l.contains(h.getNorthEast()))){window.location.href="?id="+i.properties.id}})}return F}function matchesCompartment(a,b){if(TRANSPORT===a){return(0==(b.properties.layer&NON_TRANSPORT_MASK))&&(0!=(b.properties.layer&TRANSPORT_MASK))}return(0==(b.properties.layer&TRANSPORT_MASK))||(0!=(b.properties.layer&NON_TRANSPORT_MASK))}function getFilteredJson(b,j,m,e,p,q,g,d,o,l,a,k,f){var h={},i=$("#"+o),c=i.width()-2,n=i.height()-2;return L.geoJson(e,{pointToLayer:function(r,s){return pnt2layer(b,j,m,r,g,d,l,a,k,c,n,p,q,h)},filter:function(s,r){return f(s)},onEachFeature:function(s,r){s.layer=r}})}function loadGeoJson(b,p,f,d,j,g,n,l,i,k,m,h,a,o,q){var c=getFilteredJson(b,g,j,p,k,m,f,d,l,h,a,o==null?i:o,function(r){return(0!=(r.properties.layer&q))&&(0==(r.properties.layer&UBIQUITOUS_MASK))&&matchesCompartment(i,r)}),e=getFilteredJson(b,g,j,p,k,m,f,d,l,h,a,o==null?i:o,function(r){return(0!=(r.properties.layer&q))&&(0!=(r.properties.layer&UBIQUITOUS_MASK))&&matchesCompartment(i,r)});if(typeof b.getZoom()==="undefined"&&f<=a&&a<=d||f<=b.getZoom()&&b.getZoom()<=d){if(n!=null){if(b.hasLayer(g)){n.addLayer(c);if(b.hasLayer(j)){n.addLayer(e)}}}else{g.addLayer(c);if(b.hasLayer(j)){g.addLayer(e)}}}if(f>a||d<b.getMaxZoom()){b.on("zoomend",function(r){if(f<=b.getZoom()&&b.getZoom()<=d){if(n!=null){if(b.hasLayer(g)){n.addLayer(c);if(b.hasLayer(j)){n.addLayer(e)}}}else{g.addLayer(c);if(b.hasLayer(j)){g.addLayer(e)}}}else{if(n!=null){n.removeLayer(c);n.removeLayer(e)}else{g.removeLayer(c);g.removeLayer(e)}}})}b.on("overlayadd",function(r){if(f<=b.getZoom()&&b.getZoom()<=d){if(r.layer===j){if(n!=null){if(b.hasLayer(g)){n.addLayer(e)}}else{g.addLayer(e)}}else{if(n!=null&&r.layer===g){n.addLayer(c);if(b.hasLayer(j)){n.addLayer(e)}}}}});b.on("overlayremove",function(r){if(f<=b.getZoom()&&b.getZoom()<=d){if(r.layer===j){if(n!=null){n.removeLayer(e)}else{g.removeLayer(e)}}else{if(n!=null&&r.layer===g){n.removeLayer(c);n.removeLayer(e)}}}});return[c.getLayers().length>0,e.getLayers().length>0]};