var UB_LAYER_NAME="<i>Ubiquitous metabolites</i>",TRANSPORT_LAYER_NAME="<i>Transport reactions</i>",LEAFLET_POPUP_MARGIN=10,ALL_COMPARTMENTS="all_comp_view",DEFAULT_LAYER="default";function adjustMapSize(b){var d=512,c=Math.max(d,Math.round(($(window).width()*0.7))),a=Math.max(d,Math.round(($(window).height()*0.6)));return adjustMapDivSize(b,c,a)}function adjustMapDivSize(d,f,b){var c=$("#"+d),e=c.height(),a=c.width();if(a!=f||e!=b){c.css({height:b,width:f});$(".leaflet-popup").css({maxHeight:b,maxWidth:f});$(".leaflet-popup-content").css({maxHeight:b-LEAFLET_POPUP_MARGIN,maxWidth:f-LEAFLET_POPUP_MARGIN})}return Math.min(f,b)}function getTiles(b,c,a){return L.tileLayer(b,{continuousWorld:true,noWrap:true,tileSize:256,maxZoom:a,minZoom:c,tms:true,updateWhenIdle:true,reuseTiles:true})}function handlePopUpClosing(b){var a=null;b.on("popupopen",function(c){a=c.popup});b.on("dragstart",function(c){if(a){b.closePopup(a);a.options.keepInView=false;b.openPopup(a);a.options.keepInView=true;a=null}})}function updateMapBounds(c,f,e){c[0][0]=c[0][0]==null?f[0][0]:Math.min(c[0][0],f[0][0]);c[0][1]=c[0][1]==null?f[0][1]:Math.max(c[0][1],f[0][1]);c[1][0]=c[1][0]==null?f[1][0]:Math.max(c[1][0],f[1][0]);c[1][1]=c[1][1]==null?f[1][1]:Math.min(c[1][1],f[1][1]);var a=c[1][0]-c[0][0],d=c[0][1]-c[1][1],b=Math.max(a,d)*0.1;c[0][0]-=b;c[0][1]+=b;c[1][0]+=b;c[1][1]-=b;e.setMaxBounds(c)}function addAttribution(b){var a=L.control.attribution({position:"bottomleft",prefix:false});a.addAttribution("<p>Ubiquitous metabolites are not shown in order to improve the performance.</p>");a.addTo(b)}function initializeMap(S,k,w,p,z,I,B,C){var o=adjustMapSize(k),O=[],P=Math.max(1,Math.round(o/MAP_DIMENSION_SIZE)),e=P+1,y=e+1,H=y+5,M=L.layerGroup(),h=L.layerGroup(),t={},u={},J=getParameter("id"),Q=getParameter("zoom"),m=Q==null?e:y,s=null,G;if(w&&typeof Object.keys(w)!=="undefined"&&Object.keys(w).length>0&&(J==null||!w.hasOwnProperty(J))){J=w.hasOwnProperty(ALL_COMPARTMENTS)?ALL_COMPARTMENTS:Object.keys(w)[0]}if(I.indexOf(J)>-1){$("#"+k).hide();$("#search").hide();$("#explanations").html("<p>We could not visualize this compartment as it is too huge ;(</p>");return}if(J!=null){u[J]=w[J];G=S[J];if(J in p){s=p[J]}var j=$(".menu_"+J);j.css("font-weight","Bold");j.click(function(){return false})}if(Q!=null&&!w.hasOwnProperty(Q)){Q=null}if(typeof G==="undefined"||G.length<=0){return null}var K=getTiles("lib/modelmap/white.jpg",P,H),V=getTiles("lib/modelmap/gray.jpg",P,H),R={};for(var U=0;U<B.length;U++){var T=L.layerGroup();R[B[U][0]]=T;if(C==null||$.inArray(B[U][0],C)==-1){O.push(T)}}O.push(M);O.push(K);O.push(h);var E=L.map(k,{maxZoom:H,minZoom:s!=null?P-1:P,zoom:m,attributionControl:false,padding:[MARGIN,MARGIN],layers:O,crs:L.CRS.Simple});if(z.indexOf(J)>-1){addAttribution(E)}handlePopUpClosing(E);var v={},d={},A=Q==null?e:H,q=[[null,null],[null,null]],F=[[null,null],[null,null],null],N=false,r=false,f=false,g;function b(X,aa,Y,Z){for(var l=0;l<B.length;l++){T=R[B[l][0]];var c=B[l][1];g=loadGeoJson(E,X,aa,Y,M,T,null,k,J,v,d,Z,P,Q,c);N|=g[1];g=loadGeoJson(E,X,aa,Y,M,h,T,k,TRANSPORT,v,d,Z,P,Q,c);N|=g[1];f|=g[0]||g[1]}}b(G[0],P,H,F);b(G[1],P,e,q);if(m>=y){b(G[2],y,H,q)}updateMapBounds(q,F,E);if(F[0][0]!=null&&F[1][0]!=null){if(F[2]!=null){E.setView(F[2],m)}else{var W=new L.LatLngBounds(F[0],F[1]).getCenter();E.setView(W,m)}}else{E.setView([0,0],m)}var x=$("#"+k);x.bind("resize",function(){var i=x.height(),c=x.width();$(".leaflet-popup").css({maxHeight:i,maxWidth:c});$(".leaflet-popup-content").css({maxHeight:i-LEAFLET_POPUP_MARGIN,maxWidth:c-LEAFLET_POPUP_MARGIN});E.invalidateSize();E.setView(E.getCenter(),E.getZoom())});if(B.length>1){for(var U=0;U<B.length;U++){var a=B[U][0];if(a!=DEFAULT_LAYER){t[a]=R[a]}}}if(N){t[UB_LAYER_NAME]=M}if(f){t[TRANSPORT_LAYER_NAME]=h}var n={"White background":K,"Gray background":V},D=L.control.layers(n,t);D.addTo(E);initializeAutocomplete(v,d,E,k);E.on("zoomend",function(i){if(s!=null&&E.getZoom()==E.getMinZoom()){window.location.href="?id="+s+(J==null?"":("&zoom="+J))}if(E.getZoom()>A){b(G[2],y,H,q);updateMapBounds(q,F,E);var c=false;if(!t.hasOwnProperty(UB_LAYER_NAME)&&N){t[UB_LAYER_NAME]=M;c=true}if(c){D.removeFrom(E);D=L.control.layers(n,t);D.addTo(E)}A=H;initializeAutocomplete(v,d,E,k)}});$("#a-"+k).on("click",function(){window.setTimeout(function(){E.invalidateSize()})});return E}function initializeAutocomplete(a,d,e,c){var b=document.getElementById("search_form_"+c);if(b!==null){var f=$("#tags_"+c);f.autocomplete({source:Object.keys(a),autoFocus:true});f.keypress(function(h){var g=h.keyCode||h.which;if(g===$.ui.keyCode.ENTER){search(e,a,d,c);h.preventDefault()}});b.onclick=function(){search(e,a,d,c)}}}function overlay(){var b=document.getElementById("overlay");var c=$("#embed-size-width"),a=$("#embed-size-height");update_embed_value(c.val(),a.val());b.style.visibility=(b.style.visibility==="visible")?"hidden":"visible";c.focusout(function(){var d=800;if(c.val()){var e=parseInt(c.val());if(!isNaN(e)&&e>0){d=e}else{c.val(d)}}else{c.val(d)}update_embed_value(d,a.val())});a.focus(function(){a.select()});c.focus(function(){c.select()});a.focusout(function(){var e=800;if(a.val()){var d=parseInt(a.val());if(!isNaN(d)&&d>0){e=d}else{a.val(e)}}else{a.val(e)}update_embed_value(c.val(),e)});$("#embed-html-snippet").focus(function(){$(this).select()})}function getParameter(b){var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}}function update_embed_value(b,d){var a=getParameter(),c=$("#embed-url").val();if(a){c+="?id="+a}$("#embed-html-snippet").val('<iframe src="'+c+'" width="'+b+'" height="'+d+'" frameborder="0" style="border:0"></iframe>')};